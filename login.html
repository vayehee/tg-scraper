<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Login with Telegram</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0YG6J7SYSV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-0YG6J7SYSV');

        // --- GA fields capture ---
        let gaClientId = null;
        let gaSessionId = null;
        let gaSessionNumber = null;

        function initGAFields() {
            if (!window.gtag) return;
            try {
                gtag('get', 'G-0YG6J7SYSV', 'client_id', function (clientId) {
                    gaClientId = clientId;
                    console.log('GA client_id:', clientId);
                });
                gtag('get', 'G-0YG6J7SYSV', 'session_id', function (sessionId) {
                    gaSessionId = sessionId;
                    console.log('GA session_id:', sessionId);
                });
                gtag('get', 'G-0YG6J7SYSV', 'session_number', function (sessionNumber) {
                    gaSessionNumber = sessionNumber;
                    console.log('GA session_number:', sessionNumber);
                });
            } catch (e) {
                console.warn('Could not get GA fields', e);
            }
        }

        window.addEventListener('load', initGAFields);
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: #020617;
            border-radius: 16px;
            padding: 32px 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-width: 360px;
            width: 100%;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.4rem;
        }
        p {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #9ca3af;
        }
        .status {
            margin-top: 16px;
            font-size: 0.85rem;
            min-height: 1.2em;
            color: #22c55e;
            word-break: break-word;
        }
        .status.error {
            color: #f97373;
        }

        .tg-logout-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            background: #2aabee;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s ease;
        }
        .tg-logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0.95;
        }
        .tg-logout-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Login with Telegram</h1>
        <p id="subtitle">Click the Telegram button below to sign in.</p>

        <div id="tg-login-container">
            <!-- Telegram widget snippet -->
            <script async
                src="https://telegram.org/js/telegram-widget.js?22"
                data-telegram-login="__TELEGRAM_BOT_NAME__"
                data-size="large"
                data-onauth="onTelegramAuth(user)"
                data-request-access="write">
            </script>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script type="text/javascript">
        function setStatus(msg, isError) {
            var el = document.getElementById("status");
            el.textContent = msg || "";
            if (isError) {
                el.classList.add("error");
            } else {
                el.classList.remove("error");
            }
        }

        function applyLoggedInUI(username) {
            var subtitle = document.getElementById("subtitle");
            var container = document.getElementById("tg-login-container");

            subtitle.textContent = "Logged in as @" + username;

            container.innerHTML = '<button id="logout-btn" class="tg-logout-btn">Log out</button>';

            var logoutBtn = document.getElementById("logout-btn");
            logoutBtn.addEventListener("click", function () {
                setStatus("Logging out...");

                fetch("/auth/logout", {
                    method: "POST",
                    credentials: "include"
                }).finally(function () {
                    window.location.reload();
                });
            });
        }

        function buildGAContext() {
            // GA fields must match what user.py expects
            return {
                client_id: gaClientId || null,
                session_id: gaSessionId || null,
                session_number: gaSessionNumber || null,
                country: null,
                region: null,
                city: null,
                address: null,
                continent: null,
                language: navigator.language || null,
                browser_language: navigator.language || null
            };
        }

        function onTelegramAuth(user) {
            setStatus("Authenticating with server...");

            var payload = {
                user: user,
                ga: buildGAContext()
            };

            fetch("/auth/telegram", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify(payload)
            })
            .then(function (res) {
                if (!res.ok) {
                    throw new Error("Server rejected login (" + res.status + ")");
                }
                return res.json();
            })
            .then(function (data) {
                var username = data.user.username || data.user.id;
                setStatus("Logged in as @" + username);
                applyLoggedInUI(username);
            })
            .catch(function (err) {
                console.error(err);
                setStatus("Login failed: " + err.message, true);
            });
        }
    </script>

</body>
</html>
