<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tchannelize Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0YG6J7SYSV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }

    gtag('js', new Date());
    gtag('config', 'G-0YG6J7SYSV');

    let gaClientId = null, gaSessionId = null, gaSessionNumber = null;

    function initGAFields() {
        if (!window.gtag) return;
        try {
            gtag('get', 'G-0YG6J7SYSV', 'client_id', function (cid) {
                gaClientId = cid;
            });

            gtag('get', 'G-0YG6J7SYSV', 'session_number', function (snum) {
                gaSessionNumber = snum;
            });

            gtag('get', 'G-0YG6J7SYSV', 'session_id', function (sid) {
                gaSessionId = sid;

                // âœ… Fire event inside the callback where `sid` is defined
                gtag('event', 'web_login', {
                    ga_session_id: sid
                });
            });
        } catch (e) {
            console.warn('GA field error', e);
        }
    }
    </script>
  <style>
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e5e7eb; min-height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center; }
    .card { background: #020617; border-radius: 16px; padding: 32px 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); max-width: 360px; width: 100%; text-align: center; }
    h1 { margin-top: 0; margin-bottom: 8px; font-size: 1.4rem; }
    p { margin-top: 0; margin-bottom: 16px; font-size: 0.9rem; color: #9ca3af; }
    .status { margin-top: 16px; font-size: 0.85rem; min-height: 1.2em; color: #22c55e; word-break: break-word; }
    .status.error { color: #f97373; }
    .tg-logout-btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; border-radius: 9999px; border: none; cursor: pointer; font-size: 0.95rem; font-weight: 500; background: #2aabee; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.25); transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s ease; }
    .tg-logout-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); opacity: 0.95; }
    .tg-logout-btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
<div class="card">
  <h1>TChannelize Login</h1>
  <p id="subtitle">Search, Analize & Monetise Telegram Channels</p>
  <div id="tg-login-container"></div>
  <div id="status" class="status"></div>
  <div id="session-key-wrapper" style="margin-top: 12px; display: none;">
    <p style="margin: 0 0 8px; font-size: 0.85rem; color: #9ca3af;">Session key:</p>
    <textarea id="session-key-textarea" readonly rows="2" style="width: 100%; font-size: 0.8rem; border-radius: 8px; padding: 6px; resize: none;"></textarea>
  </div>
</div>
<script type="text/javascript">
  var webSessionKey = null;

  function setStatus(msg, isError) {
    var el = document.getElementById("status");
    el.textContent = msg || "";
    el.classList.toggle("error", !!isError);
  }

  function buildGAContext() {
    return {
      client_id: gaClientId,
      session_id: gaSessionId,
      session_number: gaSessionNumber,
      country: null, region: null, city: null, address: null, continent: null,
      browser_language: navigator.language
    };
  }

  function applyLoggedInUI(username) {
    const subtitle = document.getElementById("subtitle");
    const container = document.getElementById("tg-login-container");
    // subtitle.textContent = "Logged in as @" + username;
    container.innerHTML =
      '<button id="logout-btn" class="tg-logout-btn" style="margin-right: 8px;">Log out</button>' +
      '<button id="get-session-btn" class="tg-logout-btn">Get Session Key</button>';

    document.getElementById("logout-btn").onclick = function () {
      setStatus("Logging out...");
      fetch("/auth/session/logout", { method: "POST", credentials: "include" })
        .finally(() => window.location.reload());
    };

    document.getElementById("get-session-btn").onclick = function () {
      setStatus("Generating session key...");
      fetch("/auth/session/key", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include"
      })
        .then(res => res.json())
        .then(data => {
          if (!data.session_key) throw new Error("No session_key returned");
          document.getElementById("session-key-textarea").value = data.session_key;
          document.getElementById("session-key-wrapper").style.display = "block";
          setStatus("Session key generated!");
        })
        .catch(err => setStatus("Failed: " + err.message, true));
    };
  }

  function onTelegramAuth(user) {
    setStatus("Authenticating with server...");
    fetch("/auth/session/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ user: user, ga: buildGAContext() })
    })
      .then(res => res.json())
      .then(data => {
        webSessionKey = data.session_key;
        applyLoggedInUI(user.username || user.id);
        setStatus("You are now logged in as @" + user.username);
      })
      .catch(err => setStatus("Login failed: " + err.message, true));
  }

  function initFromExistingSession() {
    fetch("/auth/me", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (!data || !data.user || !data.session) throw new Error("Invalid session");
        webSessionKey = data.session.session_key;
        applyLoggedInUI(data.user.username || data.user.id);
      })
      .catch(err => console.log("Session init fail:", err.message));
  }

  function showTelegramLoginWidget() {
    const container = document.getElementById("tg-login-container");
    if (!container.querySelector("script[data-telegram-login]")) {
      const script = document.createElement("script");
      script.src = "https://telegram.org/js/telegram-widget.js?22";
      script.setAttribute("data-telegram-login", "__TELEGRAM_BOT_NAME__");
      script.setAttribute("data-size", "large");
      script.setAttribute("data-onauth", "onTelegramAuth(user)");
      script.setAttribute("data-request-access", "write");
      script.async = true;
      container.appendChild(script);
    }
  }

  window.addEventListener("load", () => {
    initGAFields();
    initFromExistingSession();
    showTelegramLoginWidget();
  });
</script>
</body>
</html>
