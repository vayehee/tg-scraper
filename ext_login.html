<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Tchannelize Login (ext.)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) for EXTENSION data stream -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQSS5RW310"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-RQSS5RW310');

        // --- GA fields capture ---
        let gaClientId = null;
        let gaSessionId = null;
        let gaSessionNumber = null;

        function initGAFields() {
            if (!window.gtag) return;
            try {
                gtag('get', 'G-RQSS5RW310', 'client_id', function (clientId) {
                    gaClientId = clientId;
                    console.log('[EXT] GA client_id:', clientId);
                });
                gtag('get', 'G-RQSS5RW310', 'session_id', function (sessionId) {
                    gaSessionId = sessionId;
                    console.log('[EXT] GA session_id:', sessionId);
                });
                gtag('get', 'G-RQSS5RW310', 'session_number', function (sessionNumber) {
                    gaSessionNumber = sessionNumber;
                    console.log('[EXT] GA session_number:', sessionNumber);
                });
            } catch (e) {
                console.warn('[EXT] Could not get GA fields', e);
            }
        }
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: #020617;
            border-radius: 16px;
            padding: 32px 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            max-width: 360px;
            width: 100%;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.4rem;
        }
        p {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #9ca3af;
        }
        .status {
            margin-top: 16px;
            font-size: 0.85rem;
            min-height: 1.2em;
            color: #22c55e;
            word-break: break-word;
        }
        .status.error {
            color: #f97373;
        }

        .tg-logout-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            background: #2aabee;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s ease;
        }
        .tg-logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0.95;
        }
        .tg-logout-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        textarea {
            width: 100%;
            font-size: 0.85rem;
            border-radius: 8px;
            padding: 6px;
            resize: none;
            border: none;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>TChannelize</h1>
        <p id="subtitle">Search/Discover/Analize/Monetise Telegram Channels</p>

        <div id="tg-login-container">
            <div id="session-key-wrapper">
                <p style="margin-bottom: 8px; font-size: 0.85rem; color: #9ca3af;">
                    Session key:
                </p>
                <textarea id="session-key-input"
                          rows="2"
                          placeholder="Paste session key here"></textarea>
            </div>

            <div style="margin-top: 12px;">
                <button id="ext-login-btn" class="tg-logout-btn">
                    Login
                </button>
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script type="text/javascript">
        var isLoggedIn = false;
        var currentSessionKey = null;
        var currentExpiryIso = null;
        var currentUsername = null;

        function setStatus(msg, isError) {
            var el = document.getElementById("status");
            el.innerHTML = msg || "";
            if (isError) {
                el.classList.add("error");
            } else {
                el.classList.remove("error");
            }
        }

        function formatExpiry(isoString) {
            if (!isoString) {
                return "unknown time";
            }
            var d = new Date(isoString);
            if (isNaN(d.getTime())) {
                return "unknown time";
            }
            var weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

            var dayName = weekdays[d.getDay()];
            var day = d.getDate();
            var monthName = months[d.getMonth()];
            var hours = String(d.getHours()).padStart(2, "0");
            var minutes = String(d.getMinutes()).padStart(2, "0");

            return dayName + ", " + day + " " + monthName + " at " + hours + ":" + minutes;
        }

        function buildGAContext() {
            // Ready if you want to send GA context with /auth/ext/session later
            return {
                client_id: gaClientId || null,
                session_id: gaSessionId || null,
                session_number: gaSessionNumber || null,
                country: null,
                region: null,
                city: null,
                address: null,
                continent: null,
                language: navigator.language || null,
                browser_language: navigator.language || null
            };
        }

        function updateUIToLoggedIn(username, expiresAtIso) {
            isLoggedIn = true;
            currentUsername = username;
            currentExpiryIso = expiresAtIso;

            var wrapper = document.getElementById("session-key-wrapper");
            var button = document.getElementById("ext-login-btn");

            if (wrapper) {
                wrapper.style.display = "none";  // hide input box
            }
            if (button) {
                button.textContent = "Logout";   // change button text
            }

            var expiryText = formatExpiry(expiresAtIso);
            setStatus(
                "Logged in as " + username + "\n. Session will expire on " + expiryText + ".",
                false
            );

            var subtitle = document.getElementById("subtitle");
            if (subtitle) {
                subtitle.textContent = "Logged in successful! You may close this window.";
            }
        }

        function updateUIToLoggedOut(message) {
            isLoggedIn = false;
            currentUsername = null;
            currentExpiryIso = null;
            currentSessionKey = null;

            var wrapper = document.getElementById("session-key-wrapper");
            var button = document.getElementById("ext-login-btn");
            var input = document.getElementById("session-key-input");

            if (wrapper) {
                wrapper.style.display = "block";  // show input again
            }
            if (button) {
                button.textContent = "Connect";
            }
            if (input) {
                input.value = "";
            }

            setStatus(message || "Session expired! Paste a session key to connect.", false);

            var subtitle = document.getElementById("subtitle");
            if (subtitle) {
                subtitle.textContent = "Paste your Telechan session key from the web app.";
            }
        }

        function handleExtLogin() {
            var input = document.getElementById("session-key-input");
            var key = (input.value || "").trim();

            if (!key) {
                setStatus("Paste a valid session key.", true);
                return;
            }

            setStatus("Validating session key...");

            var payload = {
                session_key: key
                // If you want GA here later:
                // , ga: buildGAContext()
            };

            fetch("/auth/session/ext", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify(payload)
            })
            .then(function (res) {
                if (!res.ok) {
                    return res.json()
                        .then(function (data) {
                            var detail = (data && data.detail) ? String(data.detail) : "";

                            if (detail.toLowerCase().indexOf("already used") !== -1) {
                                setStatus(
                                    'This session key is already claimed! Click <a href="/login" target="_blank">here</a> to generate a new one.',
                                    true
                                );
                            } else if (detail.toLowerCase().indexOf("invalid") !== -1 ||
                                       detail.toLowerCase().indexOf("expired") !== -1) {
                                setStatus(
                                    'This session key is invalid or expired. Click <a href="/login" target="_blank">here</a> to generate a new one.',
                                    true
                                );
                            } else {
                                setStatus(
                                    "Login failed: " + (detail || ("Server rejected login (" + res.status + ")")),
                                    true
                                );
                            }

                            // Also notify opener about error
                            try {
                                if (window.opener && !window.opener.closed) {
                                    window.opener.postMessage({
                                        type: "tg_ext_login_error",
                                        error: detail || ("Server rejected login (" + res.status + ")")
                                    }, "*");
                                }
                            } catch (e) {
                                console.warn("Could not postMessage error to opener:", e);
                            }
                        })
                        .catch(function () {
                            setStatus("Login failed (" + res.status + ")", true);
                        });
                }

                return res.json();
            })
            .then(function (data) {
                // If error was already handled above, data might be undefined
                if (!data || !data.user) {
                    return;
                }

                var username = data.user.username || data.user.id;

                var sessionInfo = data.session || {};
                currentSessionKey = sessionInfo.session_key || key;
                var expiresAtIso = sessionInfo.expires_at || null;

                updateUIToLoggedIn("@" + username, expiresAtIso);

                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: "tg_ext_login_success",
                            user: data.user
                        }, "*");
                    }
                } catch (e) {
                    console.warn("Could not postMessage to opener:", e);
                }
            })
            .catch(function (err) {
                console.error(err);
                // This catch is mainly for network / unexpected errors
                setStatus("Login failed: " + err.message, true);
            });
        }

        function handleLogout() {
            if (!currentSessionKey) {
                updateUIToLoggedOut("Session has ended.");
                return;
            }

            setStatus("Logging out...");

            fetch("/auth/logout", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify({
                    session_key: currentSessionKey
                })
            })
            .then(function () {
                updateUIToLoggedOut("Logged out. Paste a new session key to login.");

                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: "tg_ext_logout_success"
                        }, "*");
                    }
                } catch (e) {
                    console.warn("Could not postMessage logout to opener:", e);
                }
            })
            .catch(function (err) {
                console.error(err);
                setStatus("Logout failed: " + err.message, true);
            });
        }

        function initFromExistingSession() {
            fetch("/auth/me/ext", {
                method: "GET",
                credentials: "include"
            })
            .then(function (res) {
                if (!res.ok) {
                    throw new Error("No active ext session");
                }
                return res.json();
            })
            .then(function (data) {
                if (!data || !data.user || !data.session) {
                    throw new Error("Malformed /auth/me/ext response");
                }

                var username = data.user.username || data.user.id;
                currentSessionKey = data.session.session_key || null;
                var expiresAtIso = data.session.expires_at || null;


                updateUIToLoggedIn("@" + username, expiresAtIso);
            })
            .catch(function (err) {
                console.log("[EXT] initFromExistingSession:", err.message);
            });
        }

        document.getElementById("ext-login-btn").addEventListener("click", function (e) {
            e.preventDefault();
            if (isLoggedIn) {
                handleLogout();
            } else {
                handleExtLogin();
            }
        });

        window.addEventListener("load", function () {
            initGAFields();
            initFromExistingSession();
        });
    </script>

</body>
</html>
